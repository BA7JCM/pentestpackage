import os
import pandas as pd
from xml.etree import ElementTree
from services_list import EXAMPLE_COMMANDS
from datetime import datetime

def parse_csv(filepath):
    return pd.read_csv(filepath)

def parse_xml(filepath):
    tree = ElementTree.parse(filepath)
    root = tree.getroot()
    data = []
    for host in root.findall('host'):
        for port in host.findall('ports/port'):
            data.append({
                'address': host.find('address').get('addr'),
                'port': port.get('portid'),
                'service': port.find('service').get('name'),
            })
    return pd.DataFrame(data)

def save_to_csv(data, working_directory, filename):
    timestamp = datetime.now().strftime('%Y-%m-%d')
    output_filename = os.path.join(working_directory, f"{filename}-recommended_commands-{timestamp}.csv")
    data.to_csv(output_filename, index=False)
    print(f"\nOutput file saved to {output_filename}\n")
    return output_filename


def apply_example_commands(data):
    data['example_command'] = data.apply(lambda row: EXAMPLE_COMMANDS.get(row['service'], '').format(address=row['address'], port=row['port']), axis=1)
    return data
