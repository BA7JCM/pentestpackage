#!/bin/bash

usage() {
  echo "Usage: $0 [-p ports] [-s protocol] [-l logfile] ip_list"
  echo "Options:"
  echo "  -p ports    Comma-separated list of ports to scan (default: 80)"
  echo "  -s protocol Protocol to use (default: http)"
  echo "  -l logfile  Log file to save results (default: wsf.ip_list.txt)"
  echo "  -h          Display this help message"
  exit 1
}

if [ "$#" -lt 1 ]; then
  echo "Error: No IP list file provided."
  usage
fi

IP_LIST="$1"
if [ ! -f "$IP_LIST" ] || [ ! -r "$IP_LIST" ]; then
  echo "Error: IP list file '$IP_LIST' not found or not readable."
  usage
fi

PORTS="80"
PROTOCOL="http"
LOG_FILE=""

while [ "$#" -gt 0 ]; do
  case "$1" in
    -p)
      shift
      PORTS="$1"
      ;;
    -s)
      shift
      PROTOCOL="$1"
      ;;
    -l)
      shift
      LOG_FILE="$1"
      ;;
    -h)
      usage
      ;;
  esac
  shift
done

IP_LIST_NAME=$(basename "$IP_LIST" .txt)
LOG_FILE=${LOG_FILE:-wsf.$IP_LIST_NAME.txt}

IFS=',' read -ra PORTS_ARRAY <<< "$PORTS"
IPS=()

for port in "${PORTS_ARRAY[@]}"; do
  while IFS= read -r ip; do
    IPS+=("$ip")
  done < <(nmap -Pn -p "$port" -oG - -iL "$IP_LIST" | awk '/Ports:/{gsub(/,/, " "); print $2}' | sort -u)
done

echo -e "\nScanning for $PROTOCOL services on ports \e[33m${PORTS_ARRAY[*]}\e[0m\n"

for ip in "${IPS[@]}"; do
  for port in "${PORTS_ARRAY[@]}"; do
    url="$PROTOCOL://$ip:$port/"
    status=$(curl -k -sL -w "%{http_code}" "$url" -o /dev/null)
    [[ "$status" == "200" ]] && echo -e "$ip $url" >> "$LOG_FILE"
  done
done

if [ -s "$LOG_FILE" ]; then
  echo -e "\nResults:"
  sort -u "$LOG_FILE"
  echo -e "\n\e[32mLog file saved to: $LOG_FILE\e[0m"
else
  echo -e "\nNo web services found"
fi
