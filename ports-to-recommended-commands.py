import pandas as pd
import sys
from datetime import datetime

if len(sys.argv) != 2:
    print("Usage: python suggester.py input.file.txt")
    sys.exit(1)

# Path to the input CSV file
input_file_path = sys.argv[1]

# Reading the input CSV file
columns = ['host', 'port', 'proto', 'name', 'state', 'info']
services_df = pd.read_csv(input_file_path, names=columns, skiprows=1)

# Filtering only open services
open_services_df = services_df[services_df['state'] == 'open']

# Example commands for common services
example_commands = {
    'bittorrent': 'nmap -p 6881 --script=bittorrent-discovery host',
    'cifs': 'mount -t cifs //host/share /mnt',
    'cisco-smi': 'nmap -p 4786 host',
    'dns': 'nslookup -type=any domain host',
    'ftp': 'ftp host or nmap -p 21 --script=ftp-anon,ftp-libopie,ftp-proftpd-backdoor,ftp-vsftpd-backdoor,ftp-vuln-cve2010-4221 host',
    'http': 'nikto -h http://host or curl http://host',
    'https': 'nikto -h https://host or curl https://host',
    'icmp': 'ping host',
    'imap': 'telnet host 143 or nmap -p 143 --script=imap-capabilities host',
    'ipp': 'nmap -p 631 --script=ipp-enum host',
    'ipmi': 'nmap -p 623 --script=ipmi-version host or ipmitool -H host -U user -P pass chassis status',
    'kerberos': 'nmap -p 88 --script=krb5-enum-users host',
    'ldap': 'ldapsearch -x -h host',
    'mongodb': 'mongo host',
    'ms-wbt-server': 'nmap -p 3389 --script=rdp-enum-encryption host',
    'mssql': 'sqlcmd -S host -U username -P password',
    'murmur': 'nmap -p 64738 --script=murmur-version host',
    'mysql': 'mysql -h host -u username -p',
    'netbios-ssn': 'nbtscan host',
    'nfs': 'showmount -e host',
    'ntp': 'nmap -sU -p 123 --script=ntp-info host',
    'oracle': 'tnsping host or sqlplus username/password@host',
    'pop3': 'telnet host 110 or nmap -p 110 --script=pop3-capabilities host',
    'postgresql': 'psql -h host -U username -W',
    'rdp': 'rdesktop host or nmap -p 3389 --script=rdp-enum-encryption,rdp-vuln-ms12-020 host',
    'redis': 'redis-cli -h host',
    'rpcbind': 'rpcinfo -p host',
    'rmi': 'nmap -p 1099 --script=rmi-dumpregistry host',
    'rsync': 'rsync host::',
    'sip': 'nmap -p 5060 --script=sip-enum-users host',
    'smb': 'smbclient -L //host',
    'smtp': 'nmap -p 25 --script=smtp-commands host or swaks --to email@host',
    'snmp': 'snmpwalk -c public -v1 host or nmap -p 161 --script=snmp-info host',
    'ssh': 'ssh user@host or hydra -l user -P passlist.txt ssh://host',
    'sql': 'sqlcmd -S host -U username -P password',
    'telnet': 'telnet host 23 or nmap -p 23 --script=telnet-ntlm-info host',
    'tftp': 'tftp host GET file',
    'vcenter': 'Investigate with tools like PowerCLI',
    'vnc': 'nmap -p 5900 --script=vnc-info host or vncviewer host:5900',
    'xmpp': 'nmap -p 5222 --script=xmpp-info host'
    'http-proxy': 'nmap -p 8080 --script=http-proxy-brute host',
    'https-proxy': 'nmap -p 8080 --script=http-proxy-brute host',
    'socks-proxy': 'nmap -p 1080 --script=socks-proxy-brute host',
    'smtps': 'nmap -p 465 --script=smtp-commands host',
    'imap3': 'telnet host 220 or nmap -p 220 --script=imap-capabilities host',
    'microsoft-ds': 'nmap -p 445 --script=smb-vuln-ms17-010 host',
    'ms-sql-s': 'sqlcmd -S host -U username -P password -N -l 30',
    'nntp': 'nmap -p 119 --script=nntp-ntlm-info host',
    'pptp': 'nmap -p 1723 --script=pptp-version host',
    'radius': 'nmap -p 1812,1813 --script=radius-info host',
    'sftp': 'sftp user@host',
    'smb2': 'smbclient -L //host',
    'smtp-submission': 'nmap -p 587 --script=smtp-commands host',
    'snmptrap': 'snmptrap -v 2c -c public host 1.3.6.1.2.1.1.6 1.3.6.1.6.3.1.1.5.1',
    'ssh-keygen': 'ssh-keygen -t rsa -f keyfile',
    'steam': 'nmap -p 27015 --script=steam-info host',
    'tacacs': 'nmap -p 49 --script=tacacs-plus-brute host',
    'vsphere': 'vSphere PowerCLI commands',
    'whois': 'whois domain',
    'x11': 'nmap -p 6000 --script=x11-info host',
    'afp': 'nmap -p 548 --script=afp-brute host',
    'bacnet': 'nmap -p 47808 --script=bacnet-info host',
    'cassandra': 'cqlsh host',
    'coap': 'nmap -p 5683 --script=coap-resources host',
    'dhcp': 'nmap -p 67 --script=dhcp-discover host',
    'finger': 'finger user@host',
    'git': 'git clone user@host:/path/to/repository',
    'grpc': 'nmap -p 50051 --script=grpc-info host',
    'hexenworld': 'nmap -p 26900 --script=hexenworld-info host',
    'ike': 'ike-scan host',
    'jenkins': 'nmap -p 8080 --script=jenkins-info host',
    'kafka': 'kafka-console-consumer --bootstrap-server host:9092 --topic topic_name',
    'kamailio': 'kamailio -L host',
    'microsoft-dcom': 'nmap -p 135,49152,49153,49154,49155,49156,49157 --script=dcom-vuln-ms03-026 host',
    'modbus': 'nmap -p 502 --script=modbus-discover host',
    'mqtt': 'nmap -p 1883 --script=mqtt-info host',
    'netcat': 'nc host port',
    'nfs3': 'showmount -e host',
    'nfs4': 'nmap -p 2049 --script=nfs-showmount host',
    'ntp-monlist': 'nmap -p 123 --script=ntp-monlist host',
    'openvpn': 'openvpn --config client.ovpn',
    'puppet': 'nmap -p 8140 --script=puppet-info host',
    'radmin': 'nmap -p 4899 --script=radmin host',
    'rmi-dump': 'nmap -p 1098 --script=rmi-dump host',
    'rmi-reg': 'nmap -p 1098 --script=rmi-dumpregistry host',
    'rsyncd': 'rsync host::',
    's7': 'nmap -p 102 --script=s7-info host',
    'sccm': 'nmap -p 10123 --script=sccm-info host',
    'sdr': 'nmap -p 5556,5557 --script=sdr host',
    'sip-tls': 'nmap -p 5061 --script=sip-enum-users host',
    'skype': 'nmap -p 1503,1504 --script=skype-info host',
    'smb-enum-shares': 'enum4linux -U user -P password host',
    'smb-mbenum': 'nmap -p 445 --script=smb-mbenum host',
    'smtp-enum-users': 'nmap -p 25 --script=smtp-enum-users host',
    'socks5': 'nmap -p 1080 --script=socks5-info host',
    'spring-rmi': 'nmap -p 1099 --script=spring-rmi-info host',
    'svn': 'svn checkout svn://host/repo',
    'teamspeak': 'nmap -p 10011 --script=teamspeak2-version host',
    'vmauthd': 'nmap -p 902 --script=vmauthd-info host',
    'vmware': 'vmrun -T host -u user -p password list',
    'winrm': 'winrs -r:http://host:5985 -u:user -p:password "dir C:\\"',
    'zookeeper': 'zkCli.sh -server host:2181',
}


# Grouping by both name and port for unique combinations
all_services_ports_summary = open_services_df.groupby(['name', 'port']).size().reset_index(name='occurrences')

# Applying the example commands
all_services_ports_summary['example_command'] = all_services_ports_summary['name'].map(example_commands)
all_services_ports_summary['example_command'] = all_services_ports_summary['example_command'].fillna('Investigate with appropriate tools like nmap.')

# Generating the output file name based on the input file name and current date and time (UK format)
input_filename = input_file_path.split('/')[-1].split('.')[0]
current_date_time = datetime.now().strftime('%Y-%m-%d-%H.%M')
output_file_name = f'{input_filename}-recommended_commands.{current_date_time}.csv'

# Path to save the output CSV file
output_file_path = output_file_name

# Saving the DataFrame to CSV
all_services_ports_summary.to_csv(output_file_path, index=False)

print(f"Output file saved to {output_file_path}")

