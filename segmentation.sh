#!/bin/bash

USAGE="Usage: script.sh [OPTION] [NETWORK_NAME]/[IPFILE]\nOptions:\n -I, --ingress Run ingress testing\n -E, --egress Run egress testing\n -P, --icmp Run ICMP scan on a list of IP addresses [filename]\n -h, --help Display this help and exit\nExample usage:\n ./segmentation.sh -P iplist.text\n ./segmentation.sh -I\n ./segmentation.sh -E non-cde-scope-IPs.txt\n"

if [ "$EUID" -ne 0 ]
then
  echo "Please run as sudo, this is required for the nmap UDP scan"
  exit
fi

if [ -z "$2" ] || [ -z "$(echo $2 | tr -d ' ')" ]; then
  echo -e $USAGE
  exit
else
  while [ "$1" != "" ]; do
    case $1 in
      -I | --ingress )
        xterm -e "bash -c 'nmap -sT -p- -Pn -T4 -oA nmap-TCP-$2-cde -n -iL scope-cde.txt; exec bash'" &
        xterm -e "bash -c 'sudo nmap -sU -Pn -T4 -n -oA nmap-UDP-$2-cde -n -iL scope-cde.txt; exec bash'" &
        shift
        ;;
      -E | --egress )
        xterm -e "bash -c 'nmap -sT -p- -Pn -T4 -oA nmap-TCP-cde-$2 -n -iL scope-non-cde.txt; exec bash'" &
        xterm -e "bash -c 'sudo nmap -sU -Pn -T4 -n -oA nmap-UDP-cde-$2 -n -iL scope-non-cde.txt; exec bash'" &
        xterm -e "bash -c 'sudo nmap scanme.nmap.org -n -Pn -oA nmap-cde-internet; exec bash'" &
        shift
        ;;
      --icmp | -P )
        if [ $# -lt 2 ]; then
          echo "Error: No filename supplied. $USAGE"
          exit 1
        fi
        if [ ! -f "$2" ]; then
          echo "Error: '$2' is not a file or does not exist. $USAGE"
          exit 1
        fi
        ip_addresses=($(cat "$2"))
        for ip_address in "${ip_addresses[@]}"; do
          ping -c 1 -w 1 "$ip_address" >/dev/null
          if [ $? -eq 0 ]; then
            echo "$ip_address is up"
          else
            echo "$ip_address is down"
          fi
        done
        exit
        ;;
      -h | --help )
        echo -e $USAGE
        exit
        ;;
      * )
        echo "Invalid option: $1"
        echo -e $USAGE
        exit 1
        ;;
    esac
    shift
  done
fi
