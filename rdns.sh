#!/bin/bash

clear
# Display banner
cat << "EOF"
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|P|e|n|t|e|s|t|P|a|c|k|a|g|e|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    Script: rDNS.sh
    Author: Leon Teale
    Twitter: @leonteale
    Website: cyberwolf-security.co.uk
    Version: 1.0
EOF

# ANSI color codes
RED='\033[0;31m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

# Display usage message and exit
usage() {
	echo ""
  echo "Usage: $0 [-h|--help] [-O|--output output_file] input_file"
  echo "  -h, --help               Display this help message and exit"
  echo "  -O, --output output_file Save results to output_file in CSV format"
	echo ""
	echo "Example"
  echo "./rdns.sh scope.txt --output results"
	echo ""
  exit 1
}

# Process command-line options
output_file=""
while [ $# -gt 0 ]; do
  case $1 in
    -h|--help)
      usage
      ;;
    -O|--output)
      if [ $# -lt 2 ]; then
        echo -e "${RED}Error:${NC} Output file not specified"
        usage
      fi
      output_file="$2.csv"
      shift
      ;;
    *)
      if [ ! -f "$1" ]; then
        echo -e "${RED}Error:${NC} Input file '$1' not found"
        exit 1
      fi
      input_file="$1"
      ;;
  esac
  shift
done

# Check if the input file was provided
if [ -z "${input_file}" ]; then
  echo -e "${RED}Error:${NC} Input file not specified"
  usage
fi

# Process each IP address in the input file
if [ -n "${output_file}" ]; then
  while read ip; do
    # Perform reverse DNS lookup
    rdns=$(dig +short -x "$ip")

    # Check if reverse DNS lookup succeeded
    if [ $? -ne 0 ]; then
      echo -e "${RED}Error:${NC} Failed to perform reverse DNS lookup for $ip"
      continue
    fi

    # Check if rDNS is set
    if [[ -n $rdns ]]; then
      # Extract hostname from rdns output
      hostname=$(echo "$rdns" | grep -oP 'name = \K[^,]+')
      echo "$ip,$hostname"
    else
      echo "$ip,No rDNS set"
    fi
  done < "$input_file" | tee "${output_file}"

	echo ""
  echo -e "Results saved to ${YELLOW}${output_file}${NC}"
	echo ""
else
  while read ip; do
    # Perform reverse DNS lookup
    rdns=$(dig +short -x "$ip")

    # Check if reverse DNS lookup succeeded
    if [ $? -ne 0 ]; then
      echo -e "${RED}Error:${NC} Failed to perform reverse DNS lookup for $ip"
      continue
    fi

    # Check if rDNS is set
    if [[ -n $rdns ]]; then
      # Extract hostname from rdns output
      hostname=$(echo "$rdns" | grep -oP 'name = \K[^,]+')
      echo "$ip,$hostname"
    else
      echo "$ip,No rDNS set"
    fi
  done < "$input_file"
fi
