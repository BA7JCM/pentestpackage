#!/bin/bash

clear
# Display banner
cat << "EOF"
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|P|e|n|t|e|s|t|P|a|c|k|a|g|e|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    Script: rDNS.sh
    Author: Leon Teale
    Twitter: @leonteale
    Website: cyberwolf-security.co.uk
    Version: 1.2.0
EOF

# ANSI color codes
RED='\033[0;31m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

# Display usage message and exit
usage() {
  echo -e "\nUsage: $0 [-h|--help] [-O|--output output_file] input_file"
  echo -e "  -h, --help               Display this help message and exit"
  echo -e "  -O, --output output_file Save results to output_file in CSV format"
  echo -e "\nExample"
  echo -e "./rdns.sh scope.txt --output results\n"
  exit 1
}

# Check for dependencies
if ! command -v dig &>/dev/null; then
  echo -e "${RED}Error:${NC} 'dig' command not found. Please install 'dnsutils' package."
  exit 1
fi

# Process an IP address for reverse DNS lookup
process_ip() {
  ip=$1
  rdns=$(dig +short -x "$ip")
  if [ $? -ne 0 ]; then
    echo -e "${RED}Error:${NC} Failed to perform reverse DNS lookup for $ip"
    return
  fi
  if [[ -n $rdns ]]; then
    echo "$ip,$rdns"
  else
    echo "$ip,No rDNS set"
  fi
}

# Process command-line options
output_file=""
input_file=""
while [ $# -gt 0 ]; do
  case $1 in
    -h|--help) usage ;;
    -O|--output)
      [ $# -lt 2 ] && echo -e "${RED}Error:${NC} Output file not specified" && usage
      output_file="$2.csv"
      shift ;;
    *) 
      [ ! -f "$1" ] && echo -e "${RED}Error:${NC} Input file '$1' not found" && exit 1
      input_file="$1" ;;
  esac
  shift
done

[ -z "${input_file}" ] && echo -e "${RED}Error:${NC} Input file not specified" && usage

# Process each IP address in the input file
while read ip; do
  result=$(process_ip "$ip")
  [ -n "${output_file}" ] && echo "$result" | tee -a "${output_file}" || echo "$result"
done < "$input_file"

[ -n "${output_file}" ] && echo -e "\nResults saved to ${YELLOW}${output_file}${NC}\n"
t
