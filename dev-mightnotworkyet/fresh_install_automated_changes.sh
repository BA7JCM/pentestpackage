#!/bin/bash

display_banner() {
    cat << "EOF"
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|P|e|n|t|e|s|t|P|a|c|k|a|g|e|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    Script: Fresh_installed_automated_changes.sh
    Author: Leon Teale
    Twitter: @leonteale
    Website: cyberwolf-security.co.uk
    Package: https://github.com/leonteale/pentestpackage
    Version: 1.2.4
EOF
}

RED="\033[0;31m"
GREEN="\033[0;32m"
YELLOW="\033[0;33m"
NC="\033[0m" # No Color
LOGFILE="/tmp/setup.log"
echo -e "${YELLOW}\nStarting Setup at $(date)${NC}\n" | tee -a $LOGFILE
display_banner
echo "Usage: bash $0"

log_msg() {
    echo -e "${GREEN}\n$1${NC}\n" | tee -a $LOGFILE
}

handle_error() {
    echo -e "${RED}\nError encountered during $1${NC}\n" | tee -a $LOGFILE
}

log_msg "Checking internet connection..."
if ! ping -c 1 8.8.8.8 &>/dev/null; then
    echo -e "${RED}Internet connection not detected. Exiting...${NC}" | tee -a $LOGFILE
    exit 1
fi

OS=""
if grep -iq "kali" /etc/os-release; then
    OS="kali"
elif grep -iq "parrot" /etc/os-release; then
    OS="parrot"
fi

log_msg "Setting British keyboard layout..."
setxkbmap gb
log_msg "Updating system..."
if [ "$OS" == "kali" ]; then
    sudo apt update -y >> $LOGFILE 2>&1 && sudo apt upgrade -y >> $LOGFILE 2>&1
elif [ "$OS" == "parrot" ]; then
    sudo parrot-upgrade >> $LOGFILE 2>&1
fi

log_msg "Installing Zsh, Locate, Remmina, and i3..."
sudo apt install -y zsh locate remmina i3 >> $LOGFILE 2>&1
echo -e "${YELLOW}Please enter your password to change the default shell to Zsh:${NC}"
chsh -s $(which zsh)

# Print manual instructions
echo "Generating SSH key RSA"
sudo ssh-keygen -t rsa
log_msg "Manual Steps:"
echo -e "1. Add your private ssh key to GitHub."
echo -e "   GitHub page: https://github.com/settings/ssh/new"
echo -e "   SSH public key: $(cat ~/.ssh/id_rsa.pub)\n${NC}"

# Clone repos
log_msg "Cloning common repositories..."
if [ ! -d ~/pentestpackage ]; then
    log_msg "Cloning pentestpackage repository..."
    git clone git@github.com:leonteale/pentestpackage.git || handle_error "git clone for pentestpackage"
else
    echo -e "${YELLOW}Directory 'pentestpackage' already exists, not cloning.${NC}"
fi

# Start and enable services to start on boot
log_msg "Starting PostgreSQL and enabling it to start on boot..."
sudo systemctl start postgresql >> $LOGFILE 2>&1
sudo systemctl enable postgresql >> $LOGFILE 2>&1

# Mount directories
log_msg "Mounting directories..."
[ ! -L "/Wordlists" ] && sudo ln -s /mnt/hgfs/Secure/Wordlists /Wordlists 2>/dev/null || echo -e "${YELLOW}Symbolic link '/Wordlists' already exists.${NC}"
[ ! -L "/Secure" ] && sudo ln -s /mnt/hgfs/Secure/Secure /Secure 2>/dev/null || echo -e "${YELLOW}Symbolic link '/Secure' already exists.${NC}"
[ ! -L "/Clients" ] && sudo ln -s /mnt/hgfs/Secure/Clients /Clients 2>/dev/null || echo -e "${YELLOW}Symbolic link '/Clients' already exists.${NC}"

# Append to ~/.zshrc
log_msg "Configuring .zshrc with custom aliases and functions..."
echo "alias gitgone='git add . && git commit -m \"Update\" && git push origin main'" >> ~/.zshrc
echo "alias vps='ssh -X leon@vps.cyberwolf-security.co.uk -D5291 -p49122'" >> ~/.zshrc

# Append the comb function and alias
echo "alias comb='comb_function'" >> ~/.zshrc
echo "comb_function() {" >> ~/.zshrc
echo "    domain=\"\$1\"" >> ~/.zshrc
echo "    h8mail -t \"\$domain\" -lb /Wordlists/leaks/COMB/CompilationOfManyBreaches/ --loose > \"/tmp/comb_\${domain}.txt\" &" >> ~/.zshrc
echo "}" >> ~/.zshrc

# Installing rdesktop
if ! sudo apt-get install rdesktop -y; then
    handle_error 'Installing rdesktop'
fi
# Installing tldr
if ! sudo apt-get install tldr -y; then
    handle_error 'Installing tldr'
fi
# Updating tldr
if ! tldr --update; then
    handle_error 'Updating tldr'
fi
# Installing pipx for crackmapexec
if ! python3 -m pip install pipx; then
    handle_error 'Installing pipx for crackmapexec'
fi
echo "Trying another method to install pipx just incase"
sudo apt-get install pipx

# Ensuring pipx path
if ! pipx ensurepath; then
    handle_error 'Ensuring pipx path'
fi
# Installing crackmapexec
if ! pipx install crackmapexec; then
    handle_error 'Installing crackmapexec'
fi

# Ask if the user wants to reboot
echo -e "${YELLOW}\nYou should probably reboot now. Do you want to reboot? (Y/n)${NC}"
read -r answer
if [[ $answer =~ ^[Yy]$ ]] || [[ -z $answer ]]; then
    sudo reboot
else
    log_msg "Alright, remember to reboot later for all changes to take effect!"
fi

