#!/bin/bash

# Check if IP address is provided as an argument
if [ -z "$1" ]; then
    echo -e "\e[31mUsage: $0 <server_ip>\e[0m"
    exit 1
fi

# Server information
SERVER="$1"
USER="bcn.local\\leon.teale"
PASSWORD='Leghorn rift versus!'

# Function to list folders in a share
list_folders() {
    local share=$1
    echo -e "\e[34mConnecting to $share...\e[0m"
    smbclient "//$SERVER/$share" -U "$USER%$PASSWORD" -m SMB2 << EOF
    ls
    quit
EOF
}

# List shares and filter out unnecessary lines and those with a '$'
shares=$(smbclient -L //$SERVER -U "$USER%$PASSWORD" -m SMB2 2>/dev/null | grep "Disk" | grep -v '\$' | awk '{print $1}')

# Check if any shares were found
if [ -z "$shares" ]; then
    echo -e "\e[31mNo non-administrative shares found on $SERVER.\e[0m"
    exit 1
fi

echo -e "\e[32mAvailable non-administrative shares on $SERVER:\e[0m"
echo "$shares"

# Connect to each share and list folders
for share in $shares; do
    list_folders "$share" | grep -v "NT_STATUS_ACCESS_DENIED" || echo -e "\e[31mAccess denied for $share, skipping...\e[0m"
done

echo -e "\e[32mFinished checking all shares on $SERVER.\e[0m"

