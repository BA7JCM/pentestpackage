// ====== General Utility Functions ======

let installingInterval;

function appendToLog(message, color = 'green') {
    $('#outputLog').append(`<li class="list-group-item" style="background-color: black; color: ${color};">${message}</li>`);
    autoScrollLogsConsole();
}

function autoScrollLogsConsole() {
    var logsConsole = document.getElementById("outputLog");
    logsConsole.scrollTop = logsConsole.scrollHeight;
}

function startOperationAnimation(message) {
    let dots = '';
    installingInterval = setInterval(function() {
        dots = dots.length < 3 ? dots + '.' : '';
        $('#outputLog').children().last().text(message + dots);
    }, 500);
}

function stopOperationAnimation() {
    clearInterval(installingInterval);
}

// ====== Device Functions ======

function checkDevices() {
    $.ajax({
        url: '/list-devices',
        method: 'GET',
        success: function(data) {
            let devices = data.devices;
            $('#outputLog').empty();
            if (devices.length === 0) {
                appendToLog("No ADB devices found", "red");
                $('#deviceStatus').text('Not Connected').removeClass('connected');
            } else {
                let deviceId = devices[0].split('\t')[0];
                devices.forEach(function(device) {
                    appendToLog(device);
                });
                $('#deviceStatus').html(`Connected <span style="color:green;">(${deviceId})</span>`).addClass('connected');
            }
            updateAnalyseApkVisibility();
        },
        error: function(jqXHR, textStatus) {
            appendToLog("Error fetching devices: " + textStatus, "red");
            $('#deviceStatus').text('Error').removeClass('connected');
            updateAnalyseApkVisibility();
        }
    });
}

$('#listDevices').click(checkDevices);

// ====== APK Installation and Uninstallation ======

$('#installApk').click(function() {
    $('#apkUploadForm').toggle();
});

$('#apkUploadForm').submit(function(e) {
    e.preventDefault();
    let operationMessage = 'Installing APK...';
    appendToLog(operationMessage);
    startOperationAnimation(operationMessage);

    var formData = new FormData(this);
    $.ajax({
        url: '/install-apk',
        method: 'POST',
        data: formData,
        contentType: false,
        processData: false,
        success: function(data) {
            stopOperationAnimation();
            if (data.success) {
                appendToLog('APK installed successfully!');
                $('#apkName').text(data.packageName);
                $('#appVersion').text(data.versionName);
                $('#apkUploadForm').hide();

                localStorage.setItem('installedApk', JSON.stringify({
                  exactPackageName: data.packageName,
                  displayName: data.packageName + (data.packageName !== 'None' ? ' <a href="#" id="infoUninstallLink">(uninstall)</a>' : ''),
                  versionName: data.versionName,
                  apkFilename: data.apkFilename
                }));

                if (data.packageName !== 'None') {
                    $('#apkName').append(' <a href="#" id="infoUninstallLink">(uninstall)</a>');
                } else {
                    $('#infoUninstallLink').remove();
                }
            } else {
                appendToLog(data.message, 'red');
                if (data.adbOutput) {
                    appendToLog('ADB Output: ' + data.adbOutput, 'orange');
                }
                if (data.adbError) {
                    appendToLog('ADB Error: ' + data.adbError, 'red');
                }
            }
            updateAnalyseApkVisibility();
        },
        error: function(jqXHR, textStatus) {
            stopOperationAnimation();
            appendToLog('Error installing APK: ' + textStatus, 'red');
            updateAnalyseApkVisibility();
        }
    });
});

$(document).on('click', '#infoUninstallLink', function(e) {
    e.preventDefault();
    let packageName = $('#apkName').text().split(' ')[0];
    appendToLog('Uninstalling ' + packageName + '...', 'yellow');
    $.ajax({
        url: '/uninstall-apk',
        method: 'POST',
        data: { packageName: packageName },
        success: function(data) {
            if (data.success) {
                appendToLog(data.message, 'green');
                $('#apkName').text('None');
                $('#appVersion').text('N/A');
                $('#infoUninstallLink').remove();

                localStorage.removeItem('installedApk');
            } else {
                appendToLog(data.message, 'red');
            }
            updateAnalyseApkVisibility();
        },
        error: function(jqXHR, textStatus) {
            appendToLog('Error uninstalling APK: ' + textStatus, 'red');
            updateAnalyseApkVisibility();
        }
    });
});

$(document).ready(function() {
    let installedApk = localStorage.getItem('installedApk');
    if (installedApk) {
        let apkData = JSON.parse(installedApk);
        $('#apkName').html(apkData.displayName); // Using `.html()` to render the link as well
        $('#appVersion').text(apkData.versionName);
        if (apkData.packageName !== 'None') {
            $('#apkName').append(' <a href="#" id="infoUninstallLink">(uninstall)</a>');
        }
    }

    checkDevices();
});

// ====== Logcat Functions ======

var logcatInterval;

function autoScrollLogcat() {
    var logcatConsole = $("#logcatContent");
    logcatConsole.scrollTop(logcatConsole[0].scrollHeight);
}

function updateLogcat() {
    $.ajax({
        url: '/get-logs',
        method: 'GET',
        success: function(data) {
            $('#logcatContent').text(data.logs.join('\n'));
            setTimeout(autoScrollLogcat, 5);
        }
    });
}

$('#startLogcat').click(function() {
    $.ajax({
        url: '/start-logcat',
        method: 'GET',
        success: function(data) {
            if (data.success) {
                appendToLog(data.message, 'green');
                if (!logcatInterval) {
                    logcatInterval = setInterval(updateLogcat, 1000);
                }
            } else {
                appendToLog(data.message, 'red');
            }
        }
    });
});

$('#stopLogcat').click(function() {
    $.ajax({
        url: '/stop-logcat',
        method: 'GET',
        success: function(data) {
            if (data.success) {
                appendToLog(data.message, 'green');
                if (logcatInterval) {
                    clearInterval(logcatInterval);
                    logcatInterval = null;
                }
            } else {
                appendToLog(data.message, 'red');
            }
        }
    });
});

$('#clearLogcat').click(function() {
    $.ajax({
        url: '/clear-logs',
        method: 'GET',
        success: function(data) {
            if (data.success) {
                appendToLog(data.message, 'yellow');
                $('#logcatContent').text('');
            }
        }
    });
});

function getStoredApkFilename() {
    let installedApk = localStorage.getItem('installedApk');
    if (installedApk) {
        let apkData = JSON.parse(installedApk);
        return apkData.apkFilename;
    }
    return null;
}

// ====== Analyse APK ======

$('#analyseApk').click(function() {
    const packageName = JSON.parse(localStorage.getItem('installedApk')).exactPackageName;
    const apkFilename = getStoredApkFilename();

    appendToLog('Decompiling APK...');
    startOperationAnimation('Decompiling APK');

    if (!apkFilename) {
        stopOperationAnimation();
        appendToLog("Error: APK filename not found in local storage.", "red");
        return;
    }

    $.ajax({
        url: "/analyse-apk",
        method: "POST",
        data: { apkFileName: apkFilename },
        success: function(response) {
            stopOperationAnimation();
            if (response.status === "success") {
                appendToLog("APK decompiled successfully!", "green");
                localStorage.setItem('decompiledPath', response.decompiledPath);

                appendToLog('Starting static analysis...');
                $.ajax({
                    url: "/static-analysis",
                    method: "POST",
                    data: JSON.stringify({ apkFileName: apkFilename }),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function(response) {
                        if (response.status === "success") {
                            appendToLog("Static analysis completed!", "green");
                            const vulnerabilities = response.vulnerabilities;
                            vulnerabilities.forEach(vuln => {
                                addVulnerability(vuln.title, vuln.risk);
                            });
                            response.logs.forEach(log => {
                                if(log.includes("Allowed") || log.includes("enabled") || log.includes("Enabled")) {
                                    appendToLog(log, "green");
                                } else if(log.includes("Not Allowed") || log.includes("not enabled") || log.includes("Disabled")) {
                                    appendToLog(log, "red");
                                } else {
                                    appendToLog(log, "orange");
                                }
                            });
                        } else {
                            appendToLog("Error during static analysis.", "red");
                        }
                    },
                    error: function() {
                        appendToLog("Server error during static analysis.", "red");
                    }
                });
            } else {
                appendToLog("Error during APK decompilation.", "red");
            }
        },
        error: function() {
            stopOperationAnimation();
            appendToLog("Server error during APK decompilation.", "red");
        }
    });
});



// ====== Vulnerabilities ======

function addVulnerability(vulnerability, riskLevel) {
    const vulnerabilitiesList = document.getElementById('vulnerabilitiesList');
    const li = document.createElement('li');
    li.textContent = vulnerability;
    li.classList.add(`vulnerability-${riskLevel}`);
    vulnerabilitiesList.appendChild(li);
}

function updateAnalyseApkVisibility() {
    const isDeviceConnected = $('#deviceStatus').hasClass('connected');
    const isApkInstalled = $('#apkName').text().trim() !== "None";
    if (isDeviceConnected && isApkInstalled) {
        $('#analyseApk').show();
    } else {
        $('#analyseApk').hide();
    }
}

$(document).ready(function() {
    updateAnalyseApkVisibility();
});
