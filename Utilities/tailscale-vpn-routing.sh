#!/bin/bash

# Script to enable/disable IP forwarding and configure firewall for NAT and forwarding
# Usage:
# ./script.sh --start  : Enable IP forwarding and set up NAT and firewall rules
# ./script.sh --stop   : Disable IP forwarding and remove NAT and firewall rules

# Your external interface connected to the work network
EXTERNAL_INTERFACE="eth0"
# Your Tailscale interface
TAILSCALE_INTERFACE="tailscale0"

# Function to enable IP forwarding
enable_ip_forwarding() {
    echo "Enabling IP forwarding..."
    echo 1 > /proc/sys/net/ipv4/ip_forward || { echo "Failed to enable IP forwarding"; exit 1; }
}

# Function to disable IP forwarding
disable_ip_forwarding() {
    echo "Disabling IP forwarding..."
    echo 0 > /proc/sys/net/ipv4/ip_forward || { echo "Failed to disable IP forwarding"; exit 1; }
}

# Function to add firewall rules
add_firewall_rules() {
    echo "Adding NAT and forwarding firewall rules..."
    iptables -t nat -A POSTROUTING -o $EXTERNAL_INTERFACE -j MASQUERADE || { echo "Failed to add NAT rule"; exit 1; }
    iptables -A FORWARD -i $TAILSCALE_INTERFACE -o $EXTERNAL_INTERFACE -j ACCEPT || { echo "Failed to add forwarding rule for Tailscale to external"; exit 1; }
    iptables -A FORWARD -i $EXTERNAL_INTERFACE -o $TAILSCALE_INTERFACE -m state --state RELATED,ESTABLISHED -j ACCEPT || { echo "Failed to add forwarding rule for external to Tailscale"; exit 1; }
}

# Function to remove firewall rules
remove_firewall_rules() {
    echo "Removing NAT and forwarding firewall rules..."
    iptables -t nat -D POSTROUTING -o $EXTERNAL_INTERFACE -j MASQUERADE || { echo "Failed to delete NAT rule"; exit 1; }
    iptables -D FORWARD -i $TAILSCALE_INTERFACE -o $EXTERNAL_INTERFACE -j ACCEPT || { echo "Failed to delete forwarding rule for Tailscale to external"; exit 1; }
    iptables -D FORWARD -i $EXTERNAL_INTERFACE -o $TAILSCALE_INTERFACE -m state --state RELATED,ESTABLISHED -j ACCEPT || { echo "Failed to delete forwarding rule for external to Tailscale"; exit 1; }
}

# Check for root privileges
if [ "$(id -u)" != "0" ]; then
   echo "This script must be run as root" 1>&2
   exit 1
fi

# Process command line arguments
case "$1" in
    --start)
        enable_ip_forwarding
        add_firewall_rules
        ;;
    --stop)
        disable_ip_forwarding
        remove_firewall_rules
        ;;
    *)
        echo "Usage: $0 [--start|--stop]"
        exit 1
        ;;
esac

echo "Operation completed successfully."
