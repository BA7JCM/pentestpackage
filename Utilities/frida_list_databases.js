Java.perform(function () {
    var File = Java.use('java.io.File');
    var SQLiteDatabase = Java.use('android.database.sqlite.SQLiteDatabase');

    // ANSI escape codes for colors
    var colors = {
        reset: "\x1b[0m",
        bright: "\x1b[1m",
        dim: "\x1b[2m",
        underscore: "\x1b[4m",
        blink: "\x1b[5m",
        reverse: "\x1b[7m",
        hidden: "\x1b[8m",
        fg: {
            black: "\x1b[30m",
            red: "\x1b[31m",
            green: "\x1b[32m",
            yellow: "\x1b[33m",
            blue: "\x1b[34m",
            magenta: "\x1b[35m",
            cyan: "\x1b[36m",
            white: "\x1b[37m",
            crimson: "\x1b[38m"
        },
        bg: {
            black: "\x1b[40m",
            red: "\x1b[41m",
            green: "\x1b[42m",
            yellow: "\x1b[43m",
            blue: "\x1b[44m",
            magenta: "\x1b[45m",
            cyan: "\x1b[46m",
            white: "\x1b[47m",
            crimson: "\x1b[48m"
        }
    };

    // Get the package name dynamically
    var packageName = Java.use('android.app.ActivityThread').currentApplication().getApplicationContext().getPackageName();
    var dbPath = '/data/data/' + packageName + '/databases/';
    
    console.log(colors.bright + colors.fg.cyan + "[*] Databases path: " + dbPath + colors.reset);
    
    var dbDir = File.$new(dbPath);
    
    if (dbDir.exists() && dbDir.isDirectory()) {
        var files = dbDir.listFiles();
        for (var i = 0; i < files.length; i++) {
            var file = files[i];
            if (file.isFile()) {
                try {
                    console.log(colors.bright + colors.fg.yellow + "[*] Attempting to open file: " + file.getName() + colors.reset);

                    // Use the correct method overload to open the database
                    var db = SQLiteDatabase.openDatabase.overload('java.lang.String', 'android.database.sqlite.SQLiteDatabase$CursorFactory', 'int').call(
                        SQLiteDatabase, file.getAbsolutePath(), null, SQLiteDatabase.OPEN_READONLY.value
                    );

                    console.log(colors.bright + colors.fg.green + "[*] Opened database: " + file.getName() + colors.reset);

                    // Get all tables in the database
                    var cursor = db.rawQuery("SELECT name FROM sqlite_master WHERE type='table'", null);
                    if (cursor.moveToFirst()) {
                        do {
                            var tableName = cursor.getString(0);
                            console.log(colors.bright + colors.fg.magenta + "  [*] Found table: " + tableName + colors.reset);

                            // Query the table
                            var tableCursor = db.rawQuery("SELECT * FROM " + tableName, null);
                            if (tableCursor.moveToFirst()) {
                                // Print table header
                                var header = "| ";
                                for (var j = 0; j < tableCursor.getColumnCount(); j++) {
                                    header += tableCursor.getColumnName(j) + " | ";
                                }
                                console.log(colors.fg.blue + "    " + header + colors.reset);

                                // Print table rows
                                do {
                                    var row = "| ";
                                    for (var j = 0; j < tableCursor.getColumnCount(); j++) {
                                        var columnName = tableCursor.getColumnName(j);
                                        var value;
                                        try {
                                            // Attempt to get the value as a string
                                            value = tableCursor.getString(j);
                                        } catch (e) {
                                            try {
                                                // Handle BLOB data
                                                value = tableCursor.getBlob(j);
                                                if (value) {
                                                    value = "0x" + Array.prototype.map.call(new Uint8Array(value), function (x) {
                                                        return ('00' + x.toString(16)).slice(-2);
                                                    }).join('');
                                                } else {
                                                    value = "null";
                                                }
                                            } catch (blobError) {
                                                // If both string and BLOB retrieval fail, log the error
                                                console.log(colors.fg.red + "    [!] Error retrieving column '" + columnName + "': " + blobError.message + colors.reset);
                                                value = "error";
                                            }
                                        }
                                        row += value + " | ";
                                    }
                                    console.log(colors.fg.green + "    " + row + colors.reset);
                                } while (tableCursor.moveToNext());
                            }
                            tableCursor.close();
                        } while (cursor.moveToNext());
                    }
                    cursor.close();
                    db.close();
                } catch (e) {
                    console.log(colors.fg.red + "  [!] Error opening or reading file '" + file.getName() + "': " + e.message + colors.reset);
                    console.log(e.stack);
                }
            }
        }
    } else {
        console.log(colors.fg.red + "[!] Databases directory does not exist or is not a directory" + colors.reset);
    }
});
